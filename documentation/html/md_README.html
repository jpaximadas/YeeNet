<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>YeeNet: README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">YeeNet
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">README </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><blockquote class="doxtable">
<p>:warning: <b>This software defaults to transmit on the 915MHz ISM band legal in the United States. Transmitting on this band may not be legal in your country.</b> </p>
</blockquote>
<h1>How to compile</h1>
<div class="fragment"><div class="line">$ git clone --recurse-submodules https://github.com/jpaximadas/YeeNet.git</div><div class="line">$ cd YeeNet</div><div class="line">$ make -C libopencm3</div><div class="line">$ make -C my-project</div></div><!-- fragment --><p>If you have an older git, or got ahead of yourself and skipped the <code>--recurse-submodules</code> you can fix things by running <code>git submodule update --init</code> (This is only needed once)</p>
<p>Subsequent changes to the source files only require <code>make -C my-project</code></p>
<h1>How to upload</h1>
<p>This repository uses the stlink open source STM32 MCU programming toolset: <a href="https://github.com/stlink-org/stlink">https://github.com/stlink-org/stlink</a></p>
<ol type="1">
<li>Ensure BOOT0 is not set such that the board will erase the memory after being programmed</li>
<li>Ensure SWDIO, SWCLK, and GND are connected to the MCU (only connect 3.3V if you intend to power the board from the programmer)</li>
<li>Program the chip: <div class="fragment"><div class="line">$ ./st-flash --reset write awesomesauce.bin 0x8000000</div></div><!-- fragment --></li>
</ol>
<h1>How to debug</h1>
<p>Once the binary has been uploaded run the following in the the my-project directory:</p><ol type="1">
<li>Start the gdb server <div class="fragment"><div class="line">$ ./st-util</div></div><!-- fragment --></li>
<li>In another terminal&ndash;still in my-project&ndash;start GDB and configure <div class="fragment"><div class="line">$ arm-none-eabi-gdb awesomesauce.elf</div><div class="line">$ target remote localhost:4242</div><div class="line">$ load awesomesauce.elf</div></div><!-- fragment --> Further GDB on STM reading:</li>
</ol>
<p><a href="https://www.st.com/resource/en/user_manual/dm00613038-stm32cubeide-stlink-gdb-server-stmicroelectronics.pdf">https://www.st.com/resource/en/user_manual/dm00613038-stm32cubeide-stlink-gdb-server-stmicroelectronics.pdf</a></p>
<p>Note that this pdf uses the STMCube GDB server, not the open source stlink one. However, from the perspective of the GDB client, there isn't a difference. Page 6/15 of the pdf shows how to use breakpoints and watchpoints.</p>
<h1>How to use serial</h1>
<p>You can use GNU screen to interact with the board over serial. Note this program does not provide echo so your text won't appear on the screen as you type. The blinking indicators on whatever USB to UART device you are using will indicate if the command works. </p><div class="fragment"><div class="line">$ screen [PORT] 115200</div></div><!-- fragment --> <div class="fragment"><div class="line">{[PORT]```}</div><div class="line"></div><div class="line">Example:</div></div><!-- fragment --><p> $ screen /dev/ttyUSB0 115200 ```</p>
<h1>Directories</h1>
<ul>
<li>my-project contains the program</li>
<li>my-common-code contains shared files from libopencm3</li>
</ul>
<h1>Breadboard setup</h1>
<p>Development for this project currently uses a bluepill dev board. The following table shows how the pins are connected to the SX127x and USB to UART. Please read the warnings at the end of the section before attempting to the breadboard this.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone" colspan="2">Functi   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Serial TX  </td><td class="markdownTableBodyNone">PA9   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Serial RX  </td><td class="markdownTableBodyNone">PA10   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">IRQ  </td><td class="markdownTableBodyNone">PA0   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">MOSI  </td><td class="markdownTableBodyNone">PA7   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MISO  </td><td class="markdownTableBodyNone">PA6   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">SCK  </td><td class="markdownTableBodyNone">PA5   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CS/SS  </td><td class="markdownTableBodyNone">A1   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">RST  </td><td class="markdownTableBodyNone">B9   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Address Bit 0  </td><td class="markdownTableBodyNone">B10   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Address Bit 1  </td><td class="markdownTableBodyNone">B11   </td></tr>
</table>
<ul>
<li>Serial TX/RX should connect to a USB/UART chip.</li>
<li>IRQ should connect to DIO0 on the SX127x. (May be called D0 or G0 on a breakout board)</li>
<li>MOSI,MISO,SCK, and SS should connect from the bluepill to the appropriate pins on the SX127x breakout.</li>
<li>RST should connect from the bluepill to the appropriate pin on the SX1276x breakout.</li>
<li>Address bits 0 and 1 should run from the bluepill to 3.3v or ground.</li>
</ul>
<blockquote class="doxtable">
<p>:warning: <b>Do not power the bluepill from more than one voltage source.</b> This will damage the regulator on the PCB. </p>
</blockquote>
<blockquote class="doxtable">
<p>:warning: <b>Power the SX127x or SX127x dev board with 3.3 volts ONLY.</b> The layout of the pins above routes signals from the SX127x into pins of the bluepill that are NOT 5 volt tolerant. The Adafruit SX127x breakout will emit 5 volt logic signals and damage the bluepill if powered from 5 volts. </p>
</blockquote>
<h2>Recommeded way to power the boards</h2>
<ol type="1">
<li>Power the bluepill from 5 volts from the USB to UART. The bluepill will regulate this down to 3.3 volts for its own use. Alternatively, the bluepill may be powered with 3.3 volts from a regulator on the USB to UART.</li>
<li>Power the SX127x from a decent 3.3 volt regulator. The bluepill's 3.3 volt regulator is not good enough for the task. Use the one on your USB to UART if it's present.</li>
<li>Leave 3.3 volts on the ST-Link programmer disconnected.</li>
</ol>
<h1>TODO</h1>
<ol type="1">
<li>Test un-acked packets</li>
<li>Write packet router</li>
<li>Implement USB and phase out UART</li>
<li>Write up documentation</li>
<li>Improve backoff_rng in packet_handler so it doesn't exhaust the entropy pool quickly</li>
<li>Improve organization of hardware setup</li>
</ol>
<h1>Obtaining a breakout board</h1>
<p>The adafruit breakout board can occupy too much space to access all the pins and can be expensive. You can obtain a bare breakout board here:</p>
<p><a href="https://oshpark.com/shared_projects/1Yl3TOYu"></a></p>
<div class="image">
<img src="https://644db4de3505c40a0444-327723bce298e3ff5813fb42baeefbaa.ssl.cf1.rackcdn.com/0c6bf2e8049b1d7e512044f1a13aa55a.png" alt="Breakout board" width="200"/>
</div>
<p>The RFM95 radio module can be obtained from aliexpress or banggood for under five dollars a piece.</p>
<h1>Notes</h1>
<h2>SX127x Notes</h2>
<ul>
<li>The reset pin on the adafruit breakout board must be held LOW in order for the device to function, contrary to the instructions on the adafruit website.</li>
<li>The reset pin must be pulled low momentarily in order to reset the device when the mcu reboots. This guarantees registers are reset to the original state. Failing to do this can cause weird behavior.</li>
<li>In order to clear the IRQ flags register, zeros must be written twice over SPI. This is a hardware bug.</li>
<li>When putting the SX127x into LoRa mode, it must be put into the SLEEP mode first. Not STANDBY or any other modes.</li>
<li>The SPI master may not write to the FIFO outside of STANDBY mode</li>
<li>The FIFO is not always cleared during a mode change. Never assume the FIFO is automatically cleared</li>
<li>Explicit header mode in SF=6 does not work. The automatic modulation config function in this software will not reject that modulation config.</li>
<li>This code does not touch the "sync word" byte that lets LoRas reject packets automatically. <h2>Bluepill Dev Board Notes</h2>
</li>
</ul>
<ul>
<li>The PC13 LED on the "bluepill" dev board has it's ANODE tied to 3.3 volts and it's CATHODE tied to PC13 (for some reason). This means PC13 must be pulled low to turn on the LED.</li>
<li>Do not attempt to power the SX127x from the bluepill's 3.3 volt supply. The on-board regulator cannot accomplish the task during RX or TX. Your SX127x will brown out and reset. <h2>USB to UART Notes</h2>
</li>
</ul>
<ul>
<li>Using an Arduino board with the CH430 USB to UART chip as your USB to UART device,is not a simple task. What is labelled as TX on the PCB (but is actually RX from the Arduino's perspective) can be put into a 5 volt tolerant TX pin of your dev board. Here comes the hard part. What is laballed as RX on the PCB (actually TX from the Arduino's perspective) won't work if you just plug it into the RX pin of your dev board. You need to solder directly to the CH430 chip. Consult the datasheet to find where the CH430's TX pin is. The letter at the end of "CH430" matters a great deal.</li>
</ul>
<h1>Yee: <a href="https://youtu.be/IEPv31_E__4">https://youtu.be/IEPv31_E__4</a></h1>
<div class="image">
<img src="yee.jpg" alt="yee"/>
</div>
 </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
